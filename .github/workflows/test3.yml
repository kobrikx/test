name: "Test bot 3"
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  ENV: ${{ github.event.inputs.env }}
  EMAIL_RESULTS: "info@botit.co"
  MINI_BOT_ID: "Bethpage (Black Course)"

on:
  workflow_dispatch:
    inputs:
      REGION:
        type: choice
        options:
          - dev-oregon
          - prod-oregon
          - prod-california
          - prod-virginia
        required: true
        default: 'dev-oregon'
        description: 'Please choose region'


jobs:
  bot_test:
    name: "Bot Test"
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        amount: [ 50, 100, 200, 300 ]

    steps:
      - name: "Test ${{ matrix.amount }}"
        id: bot
        uses: indiesdev/curl@v1.1
        with:
          # The target URL
          # Required: true if custom-config is not set
          url: https://api.${{ github.event.inputs.REGION }}.botit.live/bot/minibot

          # The request method, basically it's one of GET|POST|PUT|PATCH
          method: "POST"

          # List of response status codes to be accepted, else it will set the job to be failed
          # If more than one value is needed, you can use comma (,) as separator
          # In this case if the response status code is not one of 200, 201 and 204, the job will be failed
          # Default is 200,201,204
          accept: 200,201,204

          headers: '{ "Content-Type": "application/json" }'

          # Body request
          # Apply only to POST|PUT request
          body: '{"count":${{ matrix.amount }},"emailResults":"${{ env.EMAIL_RESULTS }}","driverHub":"https://selenium-hub.${{ github.event.inputs.REGION }}.botit.dev:4444/","miniBotID":"${{ env.MINI_BOT_ID }}"}'

          # Request timeout (millisec)
          # Default: 1000
          timeout: 10000

          # The authentication using token
          # This will override the Authorization header, for example Authorization: Bearer QWxhZGRpbjpPcGVuU2VzYW1l
          bearer-token: ${{ secrets.bearer_token }}


          # If it is set to true, it will show the response log in the GitHub UI
          # Default: false
          log-response: true

          # The number of attempts before giving up
          # Default: 1
          retries: 1

      - name: "Use response"
        continue-on-error: true
        run: echo ${{ steps.bot.outputs.response }}
